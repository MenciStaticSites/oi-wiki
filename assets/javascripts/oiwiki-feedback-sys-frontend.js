(function($,A){typeof exports=="object"&&typeof module<"u"?A(exports):typeof define=="function"&&define.amd?define(["exports"],A):($=typeof globalThis<"u"?globalThis:$||self,A($.OIWikiFeedbackSysFrontend={}))})(this,function($){"use strict";const A='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7 14h10q.425 0 .713-.288T18 13t-.288-.712T17 12H7q-.425 0-.712.288T6 13t.288.713T7 14m0-3h10q.425 0 .713-.288T18 10t-.288-.712T17 9H7q-.425 0-.712.288T6 10t.288.713T7 11m0-3h10q.425 0 .713-.288T18 7t-.288-.712T17 6H7q-.425 0-.712.288T6 7t.288.713T7 8M4 18q-.825 0-1.412-.587T2 16V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v15.575q0 .675-.612.938T20.3 20.3L18 18zm14.85-2L20 17.125V4H4v12zM4 16V4z"/></svg>',tt='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M6.4 19L5 17.6l5.6-5.6L5 6.4L6.4 5l5.6 5.6L17.6 5L19 6.4L13.4 12l5.6 5.6l-1.4 1.4l-5.6-5.6z"/></svg>';let L="/api";const et=e=>{L=e},nt=async()=>{const e=await fetch(`${L}meta/github-app`,{method:"GET"});if(!e.ok)throw e;return(await e.json()).data},ot=()=>{const e=new URL(window.location.href),n=e.searchParams.get("oauth_token");n&&(document.cookie=`oauth_token=${n}; path=/; expires=${new Date(JSON.parse(atob(n.split(".")[1])).exp*1e3).toUTCString()}; secure`,e.searchParams.delete("oauth_token"),window.history.replaceState(null,"",e.toString()))},H=()=>document.cookie.replace(/(?:(?:^|.*;\s*)oauth_token\s*\=\s*([^;]*).*$)|^.*$/,"$1"),D=()=>{const e=H();if(!e)return;const n=e.split(".")[1],i=Array.from(atob(n),s=>s.charCodeAt(0)),o=new TextDecoder("utf-8").decode(new Uint8Array(i));return JSON.parse(o)},O=()=>{document.cookie="oauth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; secure"},at='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M5.85 17.1q1.275-.975 2.85-1.537T12 15t3.3.563t2.85 1.537q.875-1.025 1.363-2.325T20 12q0-3.325-2.337-5.663T12 4T6.337 6.338T4 12q0 1.475.488 2.775T5.85 17.1M12 13q-1.475 0-2.488-1.012T8.5 9.5t1.013-2.488T12 6t2.488 1.013T15.5 9.5t-1.012 2.488T12 13m0 9q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22"/></svg>',it='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M17 22q-1.25 0-2.125-.875T14 19q0-.15.075-.7L7.05 14.2q-.4.375-.925.588T5 15q-1.25 0-2.125-.875T2 12t.875-2.125T5 9q.6 0 1.125.213t.925.587l7.025-4.1q-.05-.175-.062-.337T14 5q0-1.25.875-2.125T17 2t2.125.875T20 5t-.875 2.125T17 8q-.6 0-1.125-.213T14.95 7.2l-7.025 4.1q.05.175.063.338T8 12t-.012.363t-.063.337l7.025 4.1q.4-.375.925-.587T17 16q1.25 0 2.125.875T20 19t-.875 2.125T17 22"/></svg>',ct='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M3 21v-4.25L16.2 3.575q.3-.275.663-.425t.762-.15t.775.15t.65.45L20.425 5q.3.275.438.65T21 6.4q0 .4-.137.763t-.438.662L7.25 21zM17.6 7.8L19 6.4L17.6 5l-1.4 1.4z"/></svg>',st='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M7 21q-.825 0-1.412-.587T5 19V6H4V4h5V3h6v1h5v2h-1v13q0 .825-.587 1.413T17 21zm2-4h2V8H9zm4 0h2V8h-2z"/></svg>',rt='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M12 17q.425 0 .713-.288T13 16v-4q0-.425-.288-.712T12 11t-.712.288T11 12v4q0 .425.288.713T12 17m0-8q.425 0 .713-.288T13 8t-.288-.712T12 7t-.712.288T11 8t.288.713T12 9m0 13q-2.075 0-3.9-.788t-3.175-2.137T2.788 15.9T2 12t.788-3.9t2.137-3.175T8.1 2.788T12 2t3.9.788t3.175 2.137T21.213 8.1T22 12t-.788 3.9t-2.137 3.175t-3.175 2.138T12 22m0-2q3.35 0 5.675-2.325T20 12t-2.325-5.675T12 4T6.325 6.325T4 12t2.325 5.675T12 20m0-8"/></svg>',dt=function(e,n){return e.reduce((i,o)=>((i[n(o)]=i[n(o)]||[]).push(o),i),{})},W=new Intl.DateTimeFormat("zh-CN",{dateStyle:"short",timeStyle:"short"});function mt(){return window.innerWidth<768}let l=null,a,j,v;const lt=()=>{a=void 0},ut=e=>{j=e},_t=e=>{v=e},ft=async()=>{var y;const n=new URL(window.location.href).hash;if(!n)return;const i=(y=/#comment-(\d+)/.exec(n))==null?void 0:y[1];if(!i)return;const o=parseInt(i);await I();const s=a==null?void 0:a.find(g=>g.id===o);if(!s)return;const t=[s.offset.start,s.offset.end],p=document.querySelector(`[data-review-enabled][data-original-document-start="${t[0]}"][data-original-document-end="${t[1]}"]`);if(!p)return;await N({el:p,forceOpenCommentsPanel:!0});const d=document.querySelector(`.comment[data-id="${o}"]`);d==null||d.classList.add("comment_highlighting"),d==null||d.scrollIntoView({behavior:"smooth",block:"center"})},N=async({el:e,forceOpenCommentsPanel:n=!1})=>{l!==e&&(l==null||delete l.dataset.reviewSelected,l=e),(!mt()&&(l!=null&&l.dataset.reviewHasComments)||n)&&(delete l.dataset.reviewFocused,l.dataset.reviewSelected="true",await C(n))},pt=()=>{l==null||delete l.dataset.reviewSelected,l=null},C=async(e=!0)=>{const n=[...await I()],i=l;i&&n.find(s=>s.offset.start===parseInt(i.dataset.originalDocumentStart)&&s.offset.end===parseInt(i.dataset.originalDocumentEnd))===void 0&&n.push({id:-1,offset:{start:parseInt(i.dataset.originalDocumentStart),end:parseInt(i.dataset.originalDocumentEnd)},commenter:{name:"",oauth_provider:"github",oauth_user_id:""},comment:"",created_time:new Date().toISOString(),last_edited_time:null,pending:!0}),await wt(n);let o=document.querySelector(`#review-comments-panel .comments_group[data-original-document-start="${l==null?void 0:l.dataset.originalDocumentStart}"][data-original-document-end="${l==null?void 0:l.dataset.originalDocumentEnd}"]`);if(o&&(o.dataset.reviewSelected="true"),o==null||o.scrollIntoView({behavior:"smooth",block:"start"}),e){const s=o==null?void 0:o.querySelector(".comment_actions_panel textarea");s==null||s.focus()}j.classList.add("review_hidden"),v.classList.remove("review_hidden")},P=()=>{v.classList.add("review_hidden"),j.classList.remove("review_hidden")},yt=async({offsets:e,content:n,onPendingFulfilled:i})=>{var y,g,k;const o=sessionStorage.getItem("commitHash");if(!o)throw new Error("找不到 Commit hash，请联系站点管理员");const s={offset:{start:e[0],end:e[1]},comment:n},t=fetch(`${L}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H()}`},body:JSON.stringify({...s,commit_hash:o})}),p=(a==null?void 0:a.length)??-1;a&&a.push({...s,commenter:{name:((y=D())==null?void 0:y.name)??"未知用户",oauth_provider:(g=D())==null?void 0:g.provider,oauth_user_id:((k=D())==null?void 0:k.id)??"-1"},id:a.length,created_time:new Date().toISOString(),last_edited_time:null,pending:!0}),await(i==null?void 0:i());const d=await t;if(!d.ok)throw a&&(a=a.filter(b=>b.id!==p)),d;a&&(a=a.map(b=>b.id===p?{...b,pending:!1}:b)),await I(!0),z()},ht=async({id:e,comment:n,onPendingFulfilled:i})=>{const o=fetch(`${L}comment/${encodeURIComponent(new URL(window.location.href).pathname)}/id/${e}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${H()}`},body:JSON.stringify({comment:n})});a&&(a=a.map(t=>t.id===e?{...t,pending:!0}:t)),await(i==null?void 0:i());const s=await o;if(!s.ok)throw a&&(a=a.map(t=>t.id===e?{...t,pending:!1}:t)),s;a&&(a=a.map(t=>t.id===e?{...t,comment:n,pending:!1}:t)),await I(!0),z()},vt=async({id:e})=>{const n=fetch(`${L}comment/${encodeURIComponent(new URL(window.location.href).pathname)}/id/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${H()}`}});a&&(a=a.map(o=>o.id===e?{...o,pending:!0}:o));const i=await n;if(!i.ok)throw a&&(a=a.map(o=>o.id===e?{...o,pending:!1}:o)),i;a&&(a=a.filter(o=>o.id!==e)),await I(!0),z()},I=async(e=!1)=>{if(!e&&a)return a;const n=await fetch(`${L}comment/${encodeURIComponent(new URL(window.location.href).pathname)}`);if(!n.ok)throw n;const i=(await n.json()).data;return a=i,i},wt=async e=>{const n=v.querySelector(".panel_main"),i=document.createDocumentFragment(),o=dt(e,s=>`${s.offset.start}-${s.offset.end}`);for(const s of Object.keys(o).sort((t,p)=>parseInt(t.split("-")[0])-parseInt(p.split("-")[0]))){const t=document.createElement("div");t.classList.add("comments_group");const p=s.split("-");t.dataset.originalDocumentStart=p[0],t.dataset.originalDocumentEnd=p[1];const d=document.querySelector(`[data-review-enabled][data-original-document-start="${t.dataset.originalDocumentStart}"][data-original-document-end="${t.dataset.originalDocumentEnd}"]`),y=(d==null?void 0:d.textContent)??"";t.innerHTML=`
      <div class="comments_group_header">
        <span class="comments_group_text_content"></span>
      </div>
      <div class="comments_group_main"></div>
      <div class="comments_group_footer">
        <div class="comment_actions_panel">
          <div class="comment_actions_header">
            <span class="comment_username"></span>
            <button class="comment_actions_item" data-action="logout">退出登录</button>
          </div>
          <textarea required placeholder="写下你的评论..."  autocapitalize="sentences" autocomplete="on" spellcheck="true" maxlength="65535"></textarea>
          <div class="comment_actions_footer">
            <span class="comment_actions_notification"></span>
            <div class="comment_actions comment_actions_login">
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_primary" data-action="login">登录到 GitHub</button>
            </div>
            <div class="comment_actions comment_actions_modify">
              <button class="comment_actions_item comment_actions_item_btn" data-action="modify_cancel">取消</button>
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_primary" data-action="modify_submit">修改</button>
            </div>
            <div class="comment_actions comment_actions_delete">
              <button class="comment_actions_item comment_actions_item_btn" data-action="delete_cancel">取消</button>
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_error" data-action="delete_confirm">删除</button>
            </div>
            <div class="comment_actions comment_actions_reply">
              <button class="comment_actions_item comment_actions_item_btn" data-action="cancel">取消</button>
              <button class="comment_actions_item comment_actions_item_btn comment_actions_item_btn_primary" data-action="submit">提交</button>
            </div>
          </div>
        </div>
      </div>
    `.trim(),t.querySelector(".comments_group_text_content").textContent=y;const g=r=>{r.style.height="5px",r.style.height=r.scrollHeight+"px"};t.querySelector(".comment_actions_panel textarea").addEventListener("input",r=>{const c=r.currentTarget;g(c)});const k=t.querySelector(".comment_username"),b=t.querySelector(".comment_actions_login"),R=t.querySelector("button.comment_actions_item[data-action='logout']"),T=D();T?(k.textContent=`作为 ${T.name} 发表评论`,b.style.display="none"):(k.textContent="登录到 GitHub 以发表评论",R.style.display="none");const E=t.querySelector(".comment_actions_modify");E.style.display="none";const F=t.querySelector(".comment_actions_delete");F.style.display="none",t.addEventListener("mouseenter",()=>{d&&(d.dataset.reviewFocused="true")}),t.addEventListener("mouseleave",()=>{d==null||delete d.dataset.reviewFocused}),t.addEventListener("click",r=>{var c;r.stopPropagation(),l==null||delete l.dataset.reviewSelected,d==null||delete d.dataset.reviewFocused,d==null||delete d.dataset.reviewSelected,(c=document.querySelector(".comments_group[data-review-selected]"))==null||delete c.dataset.reviewSelected,t.dataset.reviewSelected="true",l=d,l==null||l.scrollIntoView({behavior:"smooth",block:"center"})});const xt=o[s].sort((r,c)=>new Date(r.created_time).getTime()-new Date(c.created_time).getTime()),Ct=t.querySelector(".comments_group_main");for(const r of xt){if(r.id===-1)continue;const c=document.createElement("div");c.classList.add("comment"),r.pending&&c.classList.add("comment_pending"),c.dataset.id=r.id.toString(),c.innerHTML=`
        <div class="comment_container">
          <div class="comment_side">
            <div class="comment_user_avatar">
              <img src="${r.commenter.avatar_url}" alt="user avatar"/>
            </div>
          </div>
          <div class="comment_base">
            <div class="comment_header">
              <a class="comment_commenter"></a>
              <span class="comment_time comment_created_time">发布于 ${W.format(new Date(r.created_time))}</span>
              <span class="comment_time comment_edited_time">最后编辑于 ${r.last_edited_time?W.format(new Date(r.last_edited_time)):""}</span>
              <div class="comment_actions">
                <button class="comment_actions_item" data-action="copy_permalink" title="分享">${it}</button>
                <button class="comment_actions_item comment_actions_item_administration" data-action="modify" title="编辑">${ct}</button>
                <button class="comment_actions_item comment_actions_item_administration" data-action="delete" title="删除">${st}</button>
              </div>
            </div>
            <div class="comment_main">
              <span class="comment_content"></span>
              <span class="comment_edit_tag">(已编辑)</span>
            </div>
          </div>
        </div>
        <div class="comment_tailing">
          <button class="comment_actions_item comment_expand" data-action="expand">展开</button>
          <button class="comment_actions_item comment_expand" data-action="fold">折叠</button>
        </div>
      `.trim();const _=c.querySelector(".comment_commenter");r.commenter.name&&(_.textContent=r.commenter.name,_.title=r.commenter.name);const f=c.querySelector(".comment_user_avatar");r.commenter.profile_url&&(_.target="_blank",_.href=r.commenter.profile_url,f.style.cursor="pointer",f.addEventListener("click",()=>{window.open(r.commenter.profile_url)})),r.commenter.avatar_url||(f.innerHTML=at),c.querySelector(".comment_main .comment_content").textContent=r.comment;const M=c.querySelector(".comment_header .comment_actions");let q=!0,w=!0;(!T||T.provider!==r.commenter.oauth_provider||T.id!==r.commenter.oauth_user_id)&&(q=!1),T&&T.isAdmin===!0&&(q=!0),r.id===-1&&(q=!1),q||M.querySelectorAll(".comment_actions_item_administration").forEach(B=>{B.style.display="none"}),!q&&!w&&(M.style.display="none");const S=c.querySelector(".comment_header .comment_created_time"),x=c.querySelector(".comment_header .comment_edited_time");x.style.display="none",r.last_edited_time&&S.addEventListener("click",()=>{S.style.display="none",x.style.display=""}),x.addEventListener("click",()=>{S.style.display="",x.style.display="none"});const V=c.querySelector(".comment_main .comment_edit_tag");r.last_edited_time||(V.style.display="none"),Ct.appendChild(c)}for(const r of t.querySelectorAll(".comment_actions_item"))r.addEventListener("click",async()=>{const c=r,_=t.querySelector(".comment_actions_panel textarea"),f=t.querySelector(".comment_actions_notification"),M=async w=>{var S;if(console.error(w),w instanceof Error)f.textContent=w.message;else if(w instanceof Response){if(w.status===401){f.textContent="身份验证失效，请重新登录",O();return}if(((S=w.headers.get("content-type"))==null?void 0:S.includes("application/json"))===!0){const x=await w.json();f.textContent=x.error}else f.textContent=`未知接口错误：${w.status}(${w.statusText})`}else f.textContent="提交失败，请稍后再试"};async function q(w){var S,x,V,B,Q,X,Y,Z;switch(w){case"copy_permalink":{c.dataset.tag="using";const m=t.querySelector(`.comment:has([data-tag="using"][data-action="${c==null?void 0:c.dataset.action}"])`);delete c.dataset.tag;const u=(S=m==null?void 0:m.dataset)==null?void 0:S.id;if(u==null)return;const h=new URL(window.location.href);h.hash=`#comment-${u}`,await navigator.clipboard.writeText(h.toString()),f.textContent="已复制评论链接地址";break}case"login":{const m=await nt();window.location.href=`https://github.com/login/oauth/authorize?client_id=${m.client_id}&state=${encodeURIComponent(JSON.stringify({redirect:window.location.href}))}`;break}case"logout":{O(),window.location.reload();break}case"cancel":{_.disabled=!1,_.value="",f.textContent="",g(_);break}case"submit":{if(_.disabled=!0,!_.checkValidity()){f.textContent="请填写评论内容",_.disabled=!1;return}f.textContent="";const m=v.querySelector("[data-review-selected] button[data-action='submit']");m&&(m.disabled=!0);try{await yt({offsets:[parseInt(l.dataset.originalDocumentStart),parseInt(l.dataset.originalDocumentEnd)],content:_.value,onPendingFulfilled:async()=>{await C()}}),_.value="",f.textContent=""}catch(u){M(u)}finally{await C();const u=v.querySelector("[data-review-selected] .comment_actions_notification"),h=v.querySelector("[data-review-selected] .comment_actions_panel textarea");u&&(u.textContent=f.textContent),h&&(h.value=_.value)}break}case"modify":{q("delete_cancel"),(x=t.querySelector(`.comment[data-id="${t.dataset.modifingId}"]`))==null||x.classList.remove("comment_pending"),c.dataset.tag="using";const m=t.querySelector(`.comment:has([data-tag="using"][data-action="${c==null?void 0:c.dataset.action}"])`);delete c.dataset.tag;const u=(V=m==null?void 0:m.dataset)==null?void 0:V.id;if(u==null)return;m==null||m.classList.add("comment_pending"),E.style.display="",t.dataset.modifingId=u,_.value=((B=a==null?void 0:a.find(U=>U.id===parseInt(u)))==null?void 0:B.comment)??"";const h=t.querySelector(".comments_group_footer");h.style.display="block",g(_),h.style.display="";break}case"modify_cancel":{(Q=t.querySelector(`.comment[data-id="${t.dataset.modifingId}"]`))==null||Q.classList.remove("comment_pending"),E.style.display="none",delete t.dataset.modifingId,_.disabled=!1,_.value="",f.textContent="",g(_);break}case"modify_submit":{const m=t.dataset.modifingId;if(m==null)return;t.querySelectorAll(`.comment[data-id="${m}"] .comment_header .comment_actions`).forEach(u=>{u.disabled=!0});try{await ht({id:parseInt(m),comment:_.value,onPendingFulfilled:async()=>{await C()}}),_.value="",f.textContent=""}catch(u){M(u)}finally{await C();const u=v.querySelector("[data-review-selected] .comment_actions_notification"),h=v.querySelector("[data-review-selected] .comment_actions_panel textarea");u&&(u.textContent=f.textContent),h&&(h.value=_.value)}break}case"delete":{q("modify_cancel"),(X=t.querySelector(`.comment[data-id="${t.dataset.deletingId}"]`))==null||X.classList.remove("comment_pending"),c.dataset.tag="using";const m=t.querySelector(`.comment:has([data-tag="using"][data-action="${c==null?void 0:c.dataset.action}"])`);delete c.dataset.tag;const u=(Y=m==null?void 0:m.dataset)==null?void 0:Y.id;if(u==null)return;m==null||m.classList.add("comment_pending"),F.style.display="",t.dataset.deletingId=u,_.disabled=!0,_.value="确实要删除该评论吗？";break}case"delete_cancel":{(Z=t.querySelector(`.comment[data-id="${t.dataset.deletingId}"]`))==null||Z.classList.remove("comment_pending"),F.style.display="none",delete t.dataset.deletingId,_.disabled=!1,_.value="",f.textContent="";break}case"delete_confirm":{const m=t.dataset.deletingId;if(m==null)return;_.value="",t.querySelectorAll(`.comment[data-id="${m}"] .comment_header .comment_actions`).forEach(u=>{u.disabled=!0}),vt({id:parseInt(m)}).catch(M).finally(()=>{C().then(()=>{const u=v.querySelector("[data-review-selected] .comment_actions_notification"),h=v.querySelector("[data-review-selected] .comment_actions_panel textarea");u&&(u.textContent=f.textContent),h&&(h.value=_.value)})}),C().then(()=>{const u=v.querySelector("[data-review-selected] .comment_actions_notification"),h=v.querySelector(`.comment[data-id="${m}"] button[data-action="delete"]`),U=v.querySelector(`.comment[data-id="${m}"] button[data-action="modify"]`);u&&(u.textContent=f.textContent),h&&(h.disabled=!0),U&&(U.disabled=!0)});break}}}q(c==null?void 0:c.dataset.action)});i.appendChild(t)}for(;n.firstChild;)n.removeChild(n.firstChild);n.appendChild(i);for(const s of v.querySelectorAll(".comment")){const t=s.querySelector(".comment_main"),p=s.querySelector('.comment_tailing .comment_expand[data-action="expand"]'),d=s.querySelector('.comment_tailing .comment_expand[data-action="fold"]'),y=t.offsetHeight;t.scrollHeight<=y&&(p.style.display="none"),d.style.display="none",p.addEventListener("click",()=>{p.style.display="none",d.style.display="",t.style.maxHeight=t.scrollHeight+"px"}),d.addEventListener("click",()=>{p.style.display="",d.style.display="none",t.style.maxHeight=`${y}px`})}n.children.length===0&&(n.innerHTML=`
      <div class="comments_empty">
        ${rt}
        <span>本页暂无评论，点击段落右侧的评论按钮以添加评论</span>
      </div>
    `.trim())},z=async()=>{const e=Array.from(document.querySelectorAll("[data-review-enabled][data-original-document-start][data-original-document-end]"));await I();for(let n of e)delete n.dataset.reviewHasComments,a.find(i=>i.offset.start===parseInt(n.dataset.originalDocumentStart)&&i.offset.end===parseInt(n.dataset.originalDocumentEnd))&&(n.dataset.reviewHasComments="true")},J=({idOrClass:e,content:n,actions:i=new Map,parent:o=document.body,insertPosition:s="beforeend",tag:t="div",isClass:p=!1,initialize:d=()=>{}})=>{let y=document.querySelector(`#${e}`);if(!p&&y)return y;o.insertAdjacentHTML(s,`
    <${t} ${p?`class="${e}"`:`id="${e}"`}>
      ${n.trim()}
    </${t}>
    `.trim()),y=o.querySelector(p?`.${e}`:`#${e}`),d(y);const g=y.querySelectorAll("[data-action]");for(const k of g)k.addEventListener("click",b=>{var E;b.stopPropagation();const R=b.currentTarget,T=R.dataset.action??"";(E=i.get(T))==null||E(R)});return y},gt='<svg xmlns="http://www.w3.org/2000/svg" class="iconify-icon iconify-inline" width="1em" height="1em" viewBox="0 0 24 24"><path fill="currentColor" d="M11 11v2q0 .425.288.713T12 14t.713-.288T13 13v-2h2q.425 0 .713-.288T16 10t-.288-.712T15 9h-2V7q0-.425-.288-.712T12 6t-.712.288T11 7v2H9q-.425 0-.712.288T8 10t.288.713T9 11zm-5 7l-2.3 2.3q-.475.475-1.088.213T2 19.575V4q0-.825.588-1.412T4 2h16q.825 0 1.413.588T22 4v12q0 .825-.587 1.413T20 18zm-.85-2H20V4H4v13.125zM4 16V4z"/></svg>',bt=({el:e})=>{e.querySelector(".review-context-menu")||J({idOrClass:"review-context-menu",content:`
    <button data-action="comment">
      ${gt}
    </button>
    `,parent:e,actions:new Map([["comment",()=>{N({el:e,forceOpenCommentsPanel:!0})}]]),isClass:!0,initialize:n=>{n.addEventListener("mouseenter",()=>{e.dataset.reviewFocused="true"}),n.addEventListener("mouseleave",()=>{delete e.dataset.reviewFocused}),n.style.display="none"}})},Tt=({el:e})=>{const n=e.querySelector(".review-context-menu");if(!n){console.error("openContextMenu called but contextMenu not found");return}n.style.display=""},qt=({el:e})=>{const n=e.querySelector('.review-context-menu:not([style*="display: none"])');if(!n){console.error("closeContextMenu called but contextMenu not found");return}n.style.display="none"};let G=!1;const K="0.5.13";function St(e,{apiEndpoint:n="/api"}={}){et(n.endsWith("/")?n:n+"/"),ot();const i=Array.from(e.querySelectorAll("[data-original-document-start][data-original-document-end]"));if(!i){console.warn("oiwiki-feedback-sys-frontend not found any offsets to inject, quitting...");return}for(let o of i)o.dataset.reviewEnabled="true",o.addEventListener("click",s=>{s.stopPropagation(),N({el:s.currentTarget})}),o.addEventListener("mouseenter",s=>{Tt({el:s.currentTarget})}),o.addEventListener("mouseleave",s=>{qt({el:s.currentTarget})}),bt({el:o});if(lt(),z(),G){P(),console.log("oiwiki-feedback-sys-frontend has been successfully reset.");return}document.addEventListener("click",()=>{pt()}),ut(J({idOrClass:"review-comments-button",content:`
    <button data-action="open">
      ${A}
    </button>
    `,actions:new Map([["open",()=>C()]])})),_t(J({idOrClass:"review-comments-panel",content:`
    <div class="panel_header">
      <span>本页评论</span>
      <button data-action="close">
        ${tt}
      </button>
    </div>
    <div class="panel_main"></div>
    <div class="panel_footer">
      Powered by <a href="https://github.com/OI-wiki/feedback-sys" target="_blank">OI Wiki Feedback System</a>
    </div>
    `,actions:new Map([["close",()=>P()]])})),P(),ft(),console.log(`oiwiki-feedback-sys-frontend version ${K} has been successfully installed.`),G=!0}$.__VERSION__=K,$.setupReview=St,Object.defineProperty($,Symbol.toStringTag,{value:"Module"})});
